<!doctype html>
<html lang="fr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Preview Instagram √ó Notion</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--stroke:#e5e7eb;--text:#262626}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{padding:16px;border-bottom:1px solid var(--stroke);background:#fff;position:sticky;top:0;z-index:10}
.wrap{max-width:980px;margin:0 auto;padding:0 14px 40px}
.profile{display:flex;gap:16px;align-items:center}
.avatar{width:76px;height:76px;border-radius:50%;background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);padding:3px;position:relative}
.avatar>div{background:#fff;width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden;position:relative}
.avatar img{width:100%;height:100%;object-fit:cover;display:block;border-radius:50%}
.avatar .cam{position:absolute;right:-4px;bottom:-4px;background:#111827;color:#fff;border-radius:999px;padding:6px 8px;font-size:12px;border:2px solid #fff;cursor:pointer}
.avatar .drop{position:absolute;inset:0;border-radius:50%;outline:2px dashed transparent}
.avatar.dragover .drop{outline-color:#9ca3af}
.meta{flex:1;min-width:0}
h1{font-size:16px;margin:0 0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stats{display:flex;gap:18px;font-size:13px;color:#4b5563}
.bio{margin-top:8px;font-size:14px;line-height:1.35;color:#111827}
.actions{display:flex;gap:8px;align-items:center}
button,input,textarea{border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;background:#fff}
button{cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:16px}
.item{aspect-ratio:1/1;border-radius:10px;overflow:hidden;border:1px solid var(--stroke);background:#fff;position:relative}
.item img{width:100%;height:100%;object-fit:cover;display:block}
.topbar{display:flex;gap:10px;align-items:center;justify-content:flex-end}
.muted{color:var(--muted);font-size:12px}
dialog{border:none;border-radius:14px;padding:0;width:560px;max-width:calc(100% - 24px)}
.modal{padding:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.counter{font-size:12px;color:var(--muted)}
.error{color:#b91c1c;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="muted" id="dbShown"></div>
      <button id="btnRefresh">üîÑ Rafra√Æchir</button>
      <button id="btnSettings">‚öôÔ∏è Param√®tres</button>
    </div>
    <div class="profile" style="margin-top:10px">
      <div class="avatar" id="avatarBox">
        <div id="avatarInner">
          <span id="avatarFallback">üë§</span>
          <img id="avatarImg" alt="" style="display:none"/>
          <input id="fileInput" type="file" accept="image/png,image/jpeg" style="display:none"/>
          <span class="cam" id="camBtn">üì∑</span>
          <span class="drop"></span>
        </div>
      </div>
      <div class="meta">
        <h1 id="profileName">Mon profil Instagram</h1>
        <div class="stats">
          <div><b id="pubCount">0</b> publications</div>
          <div><b id="followers">0</b> abonn√©s</div>
          <div><b id="following">0</b> suivis</div>
        </div>
        <div class="bio" id="bioText">Ajoute ta bio (0/150)</div>
        <div class="error" id="avatarErr" style="display:none"></div>
      </div>
      <div class="actions">
        <button id="editBio">‚úèÔ∏è √âditer la bio</button>
      </div>
    </div>
  </div>
</header>
<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<dialog id="dlgSettings"><div class="modal">
  <h3 style="margin:0 0 10px">Param√®tres</h3>
  <div class="row">
    <input id="inpDB" placeholder="NOTION_DATABASE_ID (laisser vide = valeur serveur)" style="min-width:280px"/>
    <input id="inpFollowers" placeholder="Abonn√©s (optionnel)" type="number" min="0" style="width:160px"/>
    <input id="inpFollowing" placeholder="Suivis (optionnel)" type="number" min="0" style="width:140px"/>
    <button class="right" id="closeSettings">Fermer</button>
  </div>
</div></dialog>

<dialog id="dlgBio"><div class="modal">
  <h3 style="margin:0 0 10px">√âditer la bio</h3>
  <textarea id="bioArea" rows="3" maxlength="150" style="width:100%;resize:vertical" placeholder="Ta bio (150 caract√®res max)"></textarea>
  <div class="row" style="margin-top:10px">
    <div class="counter"><span id="count">0</span>/150</div>
    <button class="right" id="saveBio">Enregistrer</button>
  </div>
</div></dialog>

<script>
const grid = document.getElementById('grid')
const btnRefresh = document.getElementById('btnRefresh')
const btnSettings = document.getElementById('btnSettings')
const dlgSettings = document.getElementById('dlgSettings')
const closeSettings = document.getElementById('closeSettings')
const inpDB = document.getElementById('inpDB')
const inpFollowers = document.getElementById('inpFollowers')
const inpFollowing = document.getElementById('inpFollowing')
const dbShown = document.getElementById('dbShown')

const pubCount = document.getElementById('pubCount')
const followers = document.getElementById('followers')
const following = document.getElementById('following')
const profileName = document.getElementById('profileName')
const bioText = document.getElementById('bioText')

const dlgBio = document.getElementById('dlgBio')
const bioArea = document.getElementById('bioArea')
const saveBioBtn = document.getElementById('saveBio')
const count = document.getElementById('count')
const editBio = document.getElementById('editBio')

// Avatar elements
const avatarBox = document.getElementById('avatarBox')
const fileInput = document.getElementById('fileInput')
const camBtn = document.getElementById('camBtn')
const avatarImg = document.getElementById('avatarImg')
const avatarFallback = document.getElementById('avatarFallback')
const avatarErr = document.getElementById('avatarErr')

let items = []
let currentDB = ""

function setCount(){ count.textContent = (bioArea.value||"").length }

async function loadProfile(){
  const r = await fetch('/api/get_profile' + (currentDB ? ('?db='+encodeURIComponent(currentDB)) : ''))
  if(!r.ok) return
  const p = await r.json()
  profileName.textContent = p.name || "Mon profil Instagram"
  followers.textContent = p.followers ?? 0
  following.textContent = p.following ?? 0
  bioText.textContent = p.bio ? p.bio : "Ajoute ta bio (0/150)"
  if (p.avatarUrl){
    avatarImg.src = p.avatarUrl
    avatarImg.style.display = 'block'
    avatarFallback.style.display = 'none'
  } else {
    avatarImg.style.display = 'none'
    avatarFallback.style.display = 'block'
    avatarFallback.textContent = p.initials || "üë§"
  }
}

async function loadPosts(){
  const url = '/api/posts' + (currentDB ? ('?db='+encodeURIComponent(currentDB)) : '')
  const res = await fetch(url)
  if(!res.ok){ alert('Erreur chargement posts: '+res.statusText); return }
  items = await res.json()
  pubCount.textContent = items.length || 0
  renderGrid()
}

function renderGrid(){
  grid.innerHTML = ''
  items.forEach(p=>{
    const el = document.createElement('div')
    el.className = 'item'
    const img = document.createElement('img')
    img.src = p.cover || ''
    img.alt = ''
    el.appendChild(img)
    grid.appendChild(el)
  })
}

async function refreshAll(){
  dbShown.textContent = currentDB ? ("DB: "+currentDB.slice(0,6)+"...") : "DB: (d√©faut serveur)"
  await loadProfile()
  await loadPosts()
}

btnRefresh.addEventListener('click', refreshAll)
btnSettings.addEventListener('click', ()=> dlgSettings.showModal())
closeSettings.addEventListener('click', ()=>{
  currentDB = (inpDB.value||'').trim()
  const f = inpFollowers.value.trim(); const g = inpFollowing.value.trim()
  if(f) followers.textContent = f
  if(g) following.textContent = g
  dlgSettings.close()
  refreshAll()
})

editBio.addEventListener('click', async ()=>{
  const r = await fetch('/api/get_profile')
  const p = r.ok ? await r.json() : { bio: "" }
  bioArea.value = p.bio || ""
  setCount()
  dlgBio.showModal()
})
bioArea.addEventListener('input', setCount)
saveBioBtn.addEventListener('click', async ()=>{
  const text = (bioArea.value||"").slice(0,150)
  const res = await fetch('/api/update_bio', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ bio: text })
  })
  if(!res.ok){ alert('Erreur sauvegarde bio'); return }
  bioText.textContent = text
  dlgBio.close()
})

// Avatar upload
function validateFile(file){
  const max = 2 * 1024 * 1024; // 2MB
  const okType = ['image/png','image/jpeg'].includes(file.type)
  if (!okType) return "Formats autoris√©s : PNG, JPG"
  if (file.size > max) return "Fichier trop lourd (max 2 Mo)"
  return ""
}
async function handleAvatar(file){
  avatarErr.style.display = 'none'
  const err = validateFile(file)
  if (err){ avatarErr.textContent = err; avatarErr.style.display='block'; return }
  // read as base64
  const b64 = await new Promise((resolve, reject)=>{
    const fr = new FileReader()
    fr.onload = ()=> resolve(fr.result.split(',')[1]||"")
    fr.onerror = reject
    fr.readAsDataURL(file)
  })
  // 1) upload to blob
  const up = await fetch('/api/upload', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ filename: file.name, contentType: file.type, base64: b64 })
  })
  if (!up.ok){ avatarErr.textContent = "√âchec upload"; avatarErr.style.display='block'; return }
  const { url } = await up.json()
  // 2) save URL to Notion
  const sv = await fetch('/api/set_avatar', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ url })
  })
  if (!sv.ok){ avatarErr.textContent = "√âchec sauvegarde avatar"; avatarErr.style.display='block'; return }
  // 3) update UI
  avatarImg.src = url
  avatarImg.style.display = 'block'
  avatarFallback.style.display = 'none'
}
camBtn.addEventListener('click', ()=> fileInput.click())
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if (f) handleAvatar(f)
})
avatarBox.addEventListener('dragover', (e)=>{ e.preventDefault(); avatarBox.classList.add('dragover') })
avatarBox.addEventListener('dragleave', ()=> avatarBox.classList.remove('dragover'))
avatarBox.addEventListener('drop', (e)=>{
  e.preventDefault(); avatarBox.classList.remove('dragover')
  const f = e.dataTransfer.files?.[0]; if (f) handleAvatar(f)
})

refreshAll()
</script>
</body></html>
